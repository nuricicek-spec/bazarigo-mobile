name: 'Setup Flutter Environment'
description: 'Setup Flutter SDK with caching and dependencies'

inputs:
  flutter-version:
    description: 'Flutter SDK version'
    required: false
    default: '3.16.9'
  
  cache-key:
    description: 'Custom cache key suffix'
    required: false
    default: 'default'
  
  init-project:
    description: 'Initialize Flutter project if not exists'
    required: false
    default: 'false'

runs:
  using: 'composite'
  steps:
    - name: ğŸ“¦ Setup Flutter SDK
      uses: subosito/flutter-action@v2
      with:
        flutter-version: ${{ inputs.flutter-version }}
        cache: true
        cache-key: flutter-${{ inputs.cache-key }}-${{ runner.os }}
        cache-path: ${{ runner.tool_cache }}/flutter
    
    - name: ğŸ—ï¸ Initialize Flutter Project
      if: ${{ inputs.init-project == 'true' }}
      shell: bash
      run: |
        echo "Initializing Flutter project structure..."
        
        # 1. Ã–NCE SENÄ°N pubspec.yaml'INI KORU (eÄŸer varsa)
        if [ -f "pubspec.yaml" ]; then
          echo "Backing up existing pubspec.yaml..."
          cp pubspec.yaml /tmp/pubspec.yaml.backup
        fi
        
        # 2. GeÃ§ici dizinde temiz Flutter projesi oluÅŸtur
        mkdir -p /tmp/flutter_init
        cd /tmp/flutter_init
        flutter create --org com.bazarigo --project-name bazarigo_mobile .
        cd -
        
        # 3. Android klasÃ¶rÃ¼ yoksa oluÅŸtur
        if [ ! -d "android" ]; then
          echo "Copying Android structure..."
          cp -r /tmp/flutter_init/android .
        else
          # Android varsa, sadece eksik build dosyalarÄ±nÄ± kopyala
          # google-services.json'a DOKUNMA!
          echo "Android folder exists, only adding missing project files..."
          
          # build.gradle dosyalarÄ± (eÄŸer eksikse)
          if [ ! -f "android/build.gradle" ]; then
            cp /tmp/flutter_init/android/build.gradle android/
          fi
          
          if [ ! -f "android/gradle.properties" ]; then
            cp /tmp/flutter_init/android/gradle.properties android/
          fi
          
          # settings.gradle (senin Ã¶zel olanÄ± korunacak)
          if [ ! -f "android/settings.gradle" ]; then
            cp /tmp/flutter_init/android/settings.gradle android/
          fi
          
          # gradle wrapper dosyalarÄ±
          if [ ! -f "android/gradlew" ]; then
            cp /tmp/flutter_init/android/gradlew android/
            chmod +x android/gradlew
          fi
          
          if [ ! -f "android/gradlew.bat" ]; then
            cp /tmp/flutter_init/android/gradlew.bat android/
          fi
          
          # gradle wrapper klasÃ¶rÃ¼
          if [ ! -d "android/gradle/wrapper" ]; then
            mkdir -p android/gradle
            cp -r /tmp/flutter_init/android/gradle/wrapper android/gradle/
          fi
        fi
        
        # 4. iOS klasÃ¶rÃ¼ kontrolÃ¼ - TAMAMEN YENÄ°DEN OLUÅTUR
        echo "Forcing iOS project recreation..."
        
        # Mevcut iOS klasÃ¶rÃ¼ndeki Ã–ZEL dosyalarÄ± yedekle
        if [ -d "ios" ]; then
          echo "Backing up custom iOS files..."
          
          # GoogleService-Info.plist varsa yedekle (Firebase config - Flutter'da yok)
          if [ -f "ios/Runner/GoogleService-Info.plist" ]; then
            cp ios/Runner/GoogleService-Info.plist /tmp/GoogleService-Info.plist.backup
            echo "Backed up GoogleService-Info.plist"
          fi
          
          # AppDelegate.swift varsa yedekle
          if [ -f "ios/Runner/AppDelegate.swift" ]; then
            cp ios/Runner/AppDelegate.swift /tmp/AppDelegate.swift.backup
            echo "Backed up AppDelegate.swift"
          fi
          
          # Info.plist varsa yedekle
          if [ -f "ios/Runner/Info.plist" ]; then
            cp ios/Runner/Info.plist /tmp/Info.plist.backup
            echo "Backed up Info.plist"
          fi
        fi
        
        # iOS klasÃ¶rÃ¼nÃ¼ tamamen sil ve yeniden oluÅŸtur
        rm -rf ios 2>/dev/null || true
        cp -r /tmp/flutter_init/ios .
        
        # YedeklenmiÅŸ dosyalarÄ± geri yÃ¼kle
        if [ -f "/tmp/GoogleService-Info.plist.backup" ]; then
          echo "Restoring GoogleService-Info.plist..."
          cp /tmp/GoogleService-Info.plist.backup ios/Runner/GoogleService-Info.plist
        fi
        
        if [ -f "/tmp/AppDelegate.swift.backup" ]; then
          echo "Restoring AppDelegate.swift..."
          cp /tmp/AppDelegate.swift.backup ios/Runner/AppDelegate.swift
        fi
        
        if [ -f "/tmp/Info.plist.backup" ]; then
          echo "Restoring Info.plist..."
          cp /tmp/Info.plist.backup ios/Runner/Info.plist
        fi
        
        # 5. iOS Podfile'Ä± gÃ¼ncelle: deployment target 12.0 yap
        if [ -f "ios/Podfile" ]; then
          echo "Updating iOS Podfile deployment target to 12.0..."
          # Platform versionunu 12.0 yap
          sed -i.bak "s/platform :ios, '.*'/platform :ios, '12.0'/g" ios/Podfile
          # TÃ¼m target'larÄ±n deployment target'Ä±nÄ± gÃ¼ncelle
          sed -i.bak "s/IPHONEOS_DEPLOYMENT_TARGET = [0-9.]*/IPHONEOS_DEPLOYMENT_TARGET = 12.0/g" ios/Podfile
        fi
        
        # 6. Web klasÃ¶rÃ¼ yoksa oluÅŸtur
        if [ ! -d "web" ]; then
          echo "Copying Web structure..."
          cp -r /tmp/flutter_init/web .
        fi
        
        # 7. Lib ve test klasÃ¶rleri (sadece yoksa)
        if [ ! -d "lib" ]; then
          cp -r /tmp/flutter_init/lib .
        fi
        
        if [ ! -d "test" ]; then
          cp -r /tmp/flutter_init/test .
        fi
        
        # 8. SENÄ°N pubspec.yaml'INI GERÄ° YÃœKLE (plugin'lerle birlikte)
        if [ -f "/tmp/pubspec.yaml.backup" ]; then
          echo "Restoring your pubspec.yaml with plugins..."
          cp /tmp/pubspec.yaml.backup pubspec.yaml
        else
          echo "Using default pubspec.yaml from Flutter template"
        fi
        
        # 9. Android/app/google-services.json varsa KORU (eÄŸer varsa)
        if [ -f "android/app/google-services.json" ]; then
          echo "âœ… Keeping existing android/app/google-services.json"
        fi
        
        echo "âœ… Project initialization complete"
    
    - name: ğŸ“¥ Install Flutter Dependencies
      shell: bash
      run: |
        echo "Installing Flutter dependencies..."
        
        # Ã–NEMLÄ°: Flutter'Ä±n plugin'leri native projelere entegre etmesi iÃ§in
        # Ã¶nce clean, sonra pub get yap
        flutter clean
        flutter pub get
        
        # Flutter'Ä± plugin'leri native projelere entegre etmesi iÃ§in zorla
        echo "Forcing Flutter to integrate plugins with native projects..."
        
        # Android iÃ§in: Flutter'Ä±n gradle plugin'ini Ã§alÄ±ÅŸtÄ±r
        if [ -d "android" ]; then
          echo "Building Android project to integrate plugins..."
          cd android
          # Flutter'Ä±n gradle plugin'ini etkinleÅŸtir
          ./gradlew clean || true
          ./gradlew build --info || true
          cd ..
        fi
        
        # iOS iÃ§in: pod install'u Flutter'Ä±n kontrolÃ¼nde yap
        if [ -d "ios" ]; then
          echo "Preparing iOS project for plugin integration..."
          cd ios
          # Podfile'Ä± Flutter'Ä±n kontrolÃ¼ne bÄ±rak
          rm -rf Podfile.lock Pods 2>/dev/null || true
          cd ..
        fi
        
        echo "âœ… Dependencies installed successfully"
    
    - name: ğŸ” Flutter Doctor
      shell: bash
      run: flutter doctor -v
    
    - name: âœ… Verify Installation
      shell: bash
      run: |
        flutter --version
        dart --version
