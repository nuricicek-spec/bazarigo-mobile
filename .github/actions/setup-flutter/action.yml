name: 'Setup Flutter Environment'
description: 'Setup Flutter SDK with caching and dependencies'

inputs:
  flutter-version:
    description: 'Flutter SDK version'
    required: false
    default: '3.16.9'
  
  cache-key:
    description: 'Custom cache key suffix'
    required: false
    default: 'default'
  
  init-project:
    description: 'Initialize Flutter project if not exists'
    required: false
    default: 'false'

runs:
  using: 'composite'
  steps:
    - name: üì¶ Setup Flutter SDK
      uses: subosito/flutter-action@v2
      with:
        flutter-version: ${{ inputs.flutter-version }}
        cache: true
        cache-key: flutter-${{ inputs.cache-key }}-${{ runner.os }}
        cache-path: ${{ runner.tool_cache }}/flutter
    
    - name: üèóÔ∏è Initialize Flutter Project
      if: ${{ inputs.init-project == 'true' }}
      shell: bash
      run: |
        echo "Initializing Flutter project structure..."
        
        # 1. √ñNCE SENƒ∞N pubspec.yaml'INI KORU (eƒüer varsa)
        if [ -f "pubspec.yaml" ]; then
          echo "Backing up existing pubspec.yaml..."
          cp pubspec.yaml /tmp/pubspec.yaml.backup
        fi
        
        # 2. Ge√ßici dizinde temiz Flutter projesi olu≈ütur
        mkdir -p /tmp/flutter_init
        cd /tmp/flutter_init
        flutter create --org com.bazarigo --project-name bazarigo_mobile .
        cd -
        
        # 3. Android klas√∂r√º yoksa olu≈ütur
        if [ ! -d "android" ]; then
          echo "Copying Android structure..."
          cp -r /tmp/flutter_init/android .
        else
          # Android varsa, sadece eksik build dosyalarƒ±nƒ± kopyala
          # google-services.json'a DOKUNMA!
          echo "Android folder exists, only adding missing project files..."
          
          # build.gradle dosyalarƒ± (eƒüer eksikse)
          if [ ! -f "android/build.gradle" ]; then
            cp /tmp/flutter_init/android/build.gradle android/
          fi
          
          if [ ! -f "android/gradle.properties" ]; then
            cp /tmp/flutter_init/android/gradle.properties android/
          fi
          
          # settings.gradle (senin √∂zel olanƒ± korunacak)
          if [ ! -f "android/settings.gradle" ]; then
            cp /tmp/flutter_init/android/settings.gradle android/
          fi
          
          # gradle wrapper dosyalarƒ±
          if [ ! -f "android/gradlew" ]; then
            cp /tmp/flutter_init/android/gradlew android/
            chmod +x android/gradlew
          fi
          
          if [ ! -f "android/gradlew.bat" ]; then
            cp /tmp/flutter_init/android/gradlew.bat android/
          fi
          
          # gradle wrapper klas√∂r√º
          if [ ! -d "android/gradle/wrapper" ]; then
            mkdir -p android/gradle
            cp -r /tmp/flutter_init/android/gradle/wrapper android/gradle/
          fi
        fi
        
        # 4. iOS klas√∂r√º kontrol√º - TAMAMEN YENƒ∞DEN OLU≈ûTUR
        echo "Forcing iOS project recreation..."
        
        # Mevcut iOS klas√∂r√ºndeki √ñZEL dosyalarƒ± yedekle
        if [ -d "ios" ]; then
          echo "Backing up custom iOS files..."
          
          # GoogleService-Info.plist varsa yedekle (Firebase config - Flutter'da yok)
          if [ -f "ios/Runner/GoogleService-Info.plist" ]; then
            cp ios/Runner/GoogleService-Info.plist /tmp/GoogleService-Info.plist.backup
            echo "Backed up GoogleService-Info.plist"
          fi
          
          # AppDelegate.swift varsa yedekle
          if [ -f "ios/Runner/AppDelegate.swift" ]; then
            cp ios/Runner/AppDelegate.swift /tmp/AppDelegate.swift.backup
            echo "Backed up AppDelegate.swift"
          fi
          
          # Info.plist varsa yedekle
          if [ -f "ios/Runner/Info.plist" ]; then
            cp ios/Runner/Info.plist /tmp/Info.plist.backup
            echo "Backed up Info.plist"
          fi
        fi
        
        # iOS klas√∂r√ºn√º tamamen sil ve yeniden olu≈ütur
        rm -rf ios 2>/dev/null || true
        cp -r /tmp/flutter_init/ios .
        
        # Yedeklenmi≈ü dosyalarƒ± geri y√ºkle
        if [ -f "/tmp/GoogleService-Info.plist.backup" ]; then
          echo "Restoring GoogleService-Info.plist..."
          cp /tmp/GoogleService-Info.plist.backup ios/Runner/GoogleService-Info.plist
        fi
        
        if [ -f "/tmp/AppDelegate.swift.backup" ]; then
          echo "Restoring AppDelegate.swift..."
          cp /tmp/AppDelegate.swift.backup ios/Runner/AppDelegate.swift
        fi
        
        if [ -f "/tmp/Info.plist.backup" ]; then
          echo "Restoring Info.plist..."
          cp /tmp/Info.plist.backup ios/Runner/Info.plist
        fi
        
        # 5. Web klas√∂r√º yoksa olu≈ütur
        if [ ! -d "web" ]; then
          echo "Copying Web structure..."
          cp -r /tmp/flutter_init/web .
        fi
        
        # 6. Lib ve test klas√∂rleri (sadece yoksa)
        if [ ! -d "lib" ]; then
          cp -r /tmp/flutter_init/lib .
        fi
        
        if [ ! -d "test" ]; then
          cp -r /tmp/flutter_init/test .
        fi
        
        # 7. SENƒ∞N pubspec.yaml'INI GERƒ∞ Y√úKLE (plugin'lerle birlikte)
        if [ -f "/tmp/pubspec.yaml.backup" ]; then
          echo "Restoring your pubspec.yaml with plugins..."
          cp /tmp/pubspec.yaml.backup pubspec.yaml
        else
          echo "Using default pubspec.yaml from Flutter template"
        fi
        
        # 8. Android/app/google-services.json varsa KORU (eƒüer varsa)
        if [ -f "android/app/google-services.json" ]; then
          echo "‚úÖ Keeping existing android/app/google-services.json"
        fi
        
        echo "‚úÖ Project initialization complete"
    
    - name: üì• Install Flutter Dependencies
      shell: bash
      run: |
        echo "Installing Flutter dependencies..."
        flutter pub get
        
        # Plugin'lerin native platformlara entegre edildiƒüinden emin ol
        echo "Integrating plugins with native platforms..."
        flutter precache
        
        # Android i√ßin plugin'leri build.gradle'a ekle
        if [ -d "android" ]; then
          echo "Syncing Android project..."
          cd android
          ./gradlew app:dependencies --configuration debugCompileClasspath || true
          cd ..
        fi
        
        echo "‚úÖ Dependencies installed successfully"
    
    - name: üîç Flutter Doctor
      shell: bash
      run: flutter doctor -v
    
    - name: ‚úÖ Verify Installation
      shell: bash
      run: |
        flutter --version
        dart --version
