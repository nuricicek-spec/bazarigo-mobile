name: 'Setup Flutter Environment'
description: 'Setup Flutter SDK with caching and dependencies'

inputs:
  flutter-version:
    description: 'Flutter SDK version'
    required: false
    default: '3.16.9'
  
  cache-key:
    description: 'Custom cache key suffix'
    required: false
    default: 'default'
  
  init-project:
    description: 'Initialize Flutter project if not exists'
    required: false
    default: 'false'

runs:
  using: 'composite'
  steps:
    - name: üì¶ Setup Flutter SDK
      uses: subosito/flutter-action@v2
      with:
        flutter-version: ${{ inputs.flutter-version }}
        cache: true
        cache-key: flutter-${{ inputs.cache-key }}-${{ runner.os }}
        cache-path: ${{ runner.tool_cache }}/flutter
    
    - name: üèóÔ∏è Initialize Flutter Project
      if: ${{ inputs.init-project == 'true' }}
      shell: bash
      run: |
        echo "Initializing Flutter project structure..."
        
        # 1. √ñNCE SENƒ∞N pubspec.yaml'INI KORU (eƒüer varsa)
        if [ -f "pubspec.yaml" ]; then
          echo "Backing up existing pubspec.yaml..."
          cp pubspec.yaml /tmp/pubspec.yaml.backup
        fi
        
        # 2. Ge√ßici dizinde temiz Flutter projesi olu≈ütur
        mkdir -p /tmp/flutter_init
        cd /tmp/flutter_init
        flutter create --org com.bazarigo --project-name bazarigo_mobile .
        cd -
        
        # 3. Android klas√∂r√º yoksa olu≈ütur
        if [ ! -d "android" ]; then
          echo "Copying Android structure..."
          cp -r /tmp/flutter_init/android .
        fi
        
        # 4. iOS klas√∂r√º kontrol√º - TAMAMEN YENƒ∞DEN OLU≈ûTUR (s√ºrekli hata veriyor)
        echo "Forcing iOS project recreation..."
        rm -rf ios 2>/dev/null || true
        cp -r /tmp/flutter_init/ios .
        
        # 5. √ñzel iOS dosyalarƒ±nƒ± koru (eƒüer varsa)
        if [ -f "/tmp/flutter_init/ios/Runner/AppDelegate.swift" ]; then
          echo "Checking for custom iOS files..."
          
          # AppDelegate.swift koru
          if [ -f "ios/Runner/AppDelegate.swift" ]; then
            echo "Preserving custom AppDelegate.swift..."
            cp ios/Runner/AppDelegate.swift /tmp/AppDelegate.swift.custom
          fi
          
          # GoogleService-Info.plist koru
          if [ -f "ios/Runner/GoogleService-Info.plist" ]; then
            echo "Preserving GoogleService-Info.plist..."
            cp ios/Runner/GoogleService-Info.plist /tmp/GoogleService-Info.plist.custom
          fi
          
          # Info.plist koru
          if [ -f "ios/Runner/Info.plist" ]; then
            echo "Preserving Info.plist..."
            cp ios/Runner/Info.plist /tmp/Info.plist.custom
          fi
          
          # Flutter'ƒ±n olu≈üturduƒüu dosyalarƒ± kopyala
          cp /tmp/flutter_init/ios/Runner/AppDelegate.swift ios/Runner/
          cp /tmp/flutter_init/ios/Runner/GoogleService-Info.plist ios/Runner/
          cp /tmp/flutter_init/ios/Runner/Info.plist ios/Runner/
          
          # Yedekleri geri y√ºkle (eƒüer varsa)
          if [ -f "/tmp/AppDelegate.swift.custom" ]; then
            cp /tmp/AppDelegate.swift.custom ios/Runner/AppDelegate.swift
          fi
          if [ -f "/tmp/GoogleService-Info.plist.custom" ]; then
            cp /tmp/GoogleService-Info.plist.custom ios/Runner/GoogleService-Info.plist
          fi
          if [ -f "/tmp/Info.plist.custom" ]; then
            cp /tmp/Info.plist.custom ios/Runner/Info.plist
          fi
        fi
        
        # 6. Web klas√∂r√º yoksa olu≈ütur
        if [ ! -d "web" ]; then
          echo "Copying Web structure..."
          cp -r /tmp/flutter_init/web .
        fi
        
        # 7. Lib ve test klas√∂rleri (sadece yoksa)
        if [ ! -d "lib" ]; then
          cp -r /tmp/flutter_init/lib .
        fi
        
        if [ ! -d "test" ]; then
          cp -r /tmp/flutter_init/test .
        fi
        
        # 8. SENƒ∞N pubspec.yaml'INI GERƒ∞ Y√úKLE (plugin'lerle birlikte)
        if [ -f "/tmp/pubspec.yaml.backup" ]; then
          echo "Restoring your pubspec.yaml with plugins..."
          cp /tmp/pubspec.yaml.backup pubspec.yaml
        else
          echo "Using default pubspec.yaml from Flutter template"
        fi
        
        echo "‚úÖ Project initialization complete"
    
    - name: üì• Install Flutter Dependencies
      shell: bash
      run: |
        echo "Installing Flutter dependencies..."
        flutter pub get
        
        # Plugin'lerin native platformlara entegre edildiƒüinden emin ol
        echo "Integrating plugins with native platforms..."
        flutter precache
        
        # Android i√ßin plugin'leri build.gradle'a ekle
        if [ -d "android" ]; then
          echo "Syncing Android project..."
          cd android
          ./gradlew app:dependencies --configuration debugCompileClasspath || true
          cd ..
        fi
        
        echo "‚úÖ Dependencies installed successfully"
    
    - name: üîç Flutter Doctor
      shell: bash
      run: flutter doctor -v
    
    - name: ‚úÖ Verify Installation
      shell: bash
      run: |
        flutter --version
        dart --version
