name: ðŸ”¥ Enterprise CI/CD Pipeline

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master ]

env:
  FLUTTER_VERSION: "3.13.x"

jobs:
  # 1. QUALITY GATES - Ä°lk Ã¶nce kalite kontrolleri
  quality-gates:
    name: "ðŸŽ¯ Quality Gates"
    runs-on: ubuntu-latest
    steps:
      - name: "ðŸ“¥ Checkout code"
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: "âš™ï¸ Setup Flutter"
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          cache: true
          cache-key: flutter-${{ env.FLUTTER_VERSION }}

      - name: "ðŸ“¦ Install dependencies"
        run: flutter pub get

      - name: "ðŸ” Analyze Code"
        run: flutter analyze --no-fatal-infos

      - name: "ðŸ“ Code Metrics"
        run: |
          echo "Checking code quality gates..."
          # .ci/quality_gates dosyalarÄ±nÄ± kontrol et
          if [ -f ".ci/quality_gates/forbidden_imports.yaml" ]; then
            echo "âœ… Forbidden imports config found"
          fi
          if [ -f ".ci/quality_gates/code_quality.yaml" ]; then
            echo "âœ… Code quality config found"
          fi

      - name: "ðŸ“ Format Check"
        run: flutter format --set-exit-if-changed --dry-run lib/

  # 2. TEST EXECUTION - Testleri Ã§alÄ±ÅŸtÄ±r
  test:
    name: "ðŸ§ª Tests"
    runs-on: ubuntu-latest
    needs: quality-gates
    steps:
      - uses: actions/checkout@v4
      - uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}

      - name: "ðŸ“¦ Install dependencies"
        run: flutter pub get

      - name: "ðŸ§ª Run Tests via CI Script"
        run: |
          if [ -f ".ci/scripts/run_tests.sh" ]; then
            chmod +x .ci/scripts/run_tests.sh
            .ci/scripts/run_tests.sh
          else
            echo "âš ï¸  No run_tests.sh found, running default tests"
            flutter test --coverage
          fi

      - name: "ðŸ“Š Coverage Report"
        run: |
          if [ -f ".ci/scripts/generate_coverage.sh" ]; then
            chmod +x .ci/scripts/generate_coverage.sh
            .ci/scripts/generate_coverage.sh
          else
            echo "â„¹ï¸  No coverage script found"
          fi

      - name: "ðŸ“ˆ Upload Coverage"
        uses: codecov/codecov-action@v4
        with:
          file: ./coverage/lcov.info
          fail_ci_if_error: false

  # 3. SECURITY CHECKS - GÃ¼venlik kontrolleri
  security:
    name: "ðŸ”’ Security Scan"
    runs-on: ubuntu-latest
    needs: quality-gates
    steps:
      - uses: actions/checkout@v4
      
      - name: "ðŸ” Dependency Vulnerability Scan"
        run: |
          echo "Running security checks..."
          if [ -f ".ci/quality_gates/security_scan.yaml" ]; then
            echo "âœ… Security config found"
          fi
          # Basit gÃ¼venlik taramasÄ±
          if grep -r "API_KEY\|SECRET\|PASSWORD" lib/ --include="*.dart" 2>/dev/null; then
            echo "âš ï¸  Possible hardcoded secrets found"
          else
            echo "âœ… No hardcoded secrets found"
          fi

      - name: "ðŸ“¦ Dependency Audit"
        run: |
          echo "Checking dependencies..."
          flutter pub outdated

  # 4. BUILD - TÃ¼m platformlar iÃ§in build
  build:
    name: "ðŸ—ï¸ Build All Platforms"
    runs-on: ubuntu-latest
    needs: [test, security]
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
    
    strategy:
      matrix:
        platform: [android, web]
        # iOS iÃ§in ayrÄ± runner gerekebilir

    steps:
      - uses: actions/checkout@v4
      - uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}

      - name: "ðŸ“¦ Install dependencies"
        run: flutter pub get

      - name: "ðŸ—ï¸ Build for ${{ matrix.platform }}"
        run: |
          case ${{ matrix.platform }} in
            android)
              if [ -f ".ci/scripts/build_android.sh" ]; then
                chmod +x .ci/scripts/build_android.sh
                .ci/scripts/build_android.sh
              else
                flutter build apk --release --split-per-abi
              fi
              ;;
            web)
              if [ -f ".ci/scripts/build_web.sh" ]; then
                chmod +x .ci/scripts/build_web.sh
                .ci/scripts/build_web.sh
              else
                flutter build web --release
              fi
              ;;
          esac

      - name: "ðŸ“¦ Upload Artifacts"
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.platform }}-build
          path: |
            build/app/outputs/flutter-apk/*.apk
            build/web/
          retention-days: 7

  # 5. PERFORMANCE CHECK - Performans testleri
  performance:
    name: "âš¡ Performance"
    runs-on: ubuntu-latest
    needs: build
    if: always()
    steps:
      - uses: actions/checkout@v4
      
      - name: "ðŸ“Š Performance Metrics"
        run: |
          echo "Checking performance benchmarks..."
          if [ -f ".ci/quality_gates/performance_benchmarks.yaml" ]; then
            echo "âœ… Performance config found"
          fi
          # Basit dosya boyutu kontrolÃ¼
          find build/ -name "*.apk" -exec du -h {} \; 2>/dev/null || true
          find build/web -type f -name "*.js" -exec du -h {} \; 2>/dev/null | head -5

  # 6. NOTIFICATIONS - BaÅŸarÄ±sÄ±z olursa bildirim
  notify:
    name: "ðŸ“¢ Notifications"
    runs-on: ubuntu-latest
    needs: [quality-gates, test, security, build, performance]
    if: failure()
    steps:
      - name: "ðŸš¨ Pipeline Failed"
        run: |
          echo "CI/CD Pipeline failed!"
          echo "Failed jobs:"
          echo "${{ toJSON(needs) }}"
          echo "Please check GitHub Actions logs"
