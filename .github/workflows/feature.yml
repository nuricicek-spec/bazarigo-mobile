name: ðŸŒ¿ Feature Branch CI

permissions:
  pull-requests: write
  contents: read
  checks: write

on:
  push:
    branches:
      - 'feature/**'
  pull_request:
    branches:
      - main
      - develop

env:
  FLUTTER_VERSION: "3.16.9"
  JAVA_VERSION: "17"
  JAVA_OPTS: "-Xmx4G -XX:+UseG1GC"
  GRADLE_OPTS: "-Dorg.gradle.jvmargs=-Xmx4g -Dorg.gradle.daemon=true -Dkotlin.daemon.jvmargs=-Xmx1g"

jobs:
  validate:
    name: ðŸŽ¯ Validate Feature
    runs-on: ubuntu-latest
    timeout-minutes: 25
    
    steps:
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: ðŸ”§ Setup Flutter
        uses: ./.github/actions/setup-flutter
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
      
      - name: â˜• Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ env.JAVA_VERSION }}
          cache: 'gradle'
      
      - name: ðŸ“¦ Install lcov
        run: |
          if ! command -v lcov &> /dev/null; then
            sudo apt-get update -qq
            sudo apt-get install -y lcov bc
          fi
      
      - name: ðŸ” Run Analyzer
        run: flutter analyze --no-fatal-infos
      
      - name: ðŸ§ª Run Tests
        run: |
          if [ -f ".ci/scripts/run_tests.sh" ]; then
            bash .ci/scripts/run_tests.sh all true
          else
            flutter test --coverage
          fi
      
      - name: ðŸ“Š Generate Coverage Report
        if: success()
        continue-on-error: true
        run: |
          if [ -f ".ci/scripts/generate_coverage.sh" ]; then
            bash .ci/scripts/generate_coverage.sh
          fi
      
      - name: âœ… Run Quality Gates
        uses: ./.github/actions/run-quality-gates
      
      - name: ðŸ“ˆ Upload Coverage to Codecov
        if: success()
        uses: codecov/codecov-action@v4
        continue-on-error: true
        with:
          files: ./coverage/lcov.info
          token: ${{ secrets.CODECOV_TOKEN }}
          flags: unittests
          name: feature-coverage
          fail_ci_if_error: false

  build-android:
    name: ðŸ¤– Build Android
    needs: validate
    runs-on: ubuntu-latest
    timeout-minutes: 30
    if: success()
    
    steps:
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@v4
      
      - name: ðŸ”§ Setup Flutter
        uses: ./.github/actions/setup-flutter
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
      
      - name: â˜• Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ env.JAVA_VERSION }}
          cache: 'gradle'
      
      - name: ðŸ“ Create local.properties
        run: |
          cat > android/local.properties << EOF
          sdk.dir=$ANDROID_HOME
          flutter.sdk=$FLUTTER_ROOT
          flutter.versionCode=100
          flutter.versionName=4.0.3
          EOF
      
      - name: ðŸ—ï¸ Build Android APK
        uses: ./.github/actions/build-artifacts
        with:
          platform: android
          flavor: production
      
      - name: ðŸ“¤ Upload APK Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: android-apk-feature
          path: build/app/outputs/flutter-apk/*.apk
          retention-days: 7

  build-web:
    name: ðŸŒ Build Web
    needs: validate
    runs-on: ubuntu-latest
    timeout-minutes: 20
    if: success()
    
    steps:
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@v4
      
      - name: ðŸ”§ Setup Flutter
        uses: ./.github/actions/setup-flutter
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
      
      - name: ðŸ—ï¸ Build Web
        uses: ./.github/actions/build-artifacts
        with:
          platform: web
          flavor: production
      
      - name: ðŸ“¤ Upload Web Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: web-build-feature
          path: build/web/
          retention-days: 7

  build-ios:
    name: ðŸŽ Build iOS
    needs: validate
    runs-on: macos-latest
    timeout-minutes: 60
    if: success()
    
    steps:
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@v4
      
      - name: ðŸ”§ Setup Flutter
        uses: ./.github/actions/setup-flutter
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
      
      - name: ðŸ” Verify iOS Project
        shell: bash
        run: |
          if [ ! -f "ios/Runner.xcodeproj/project.pbxproj" ]; then
            echo "âŒ ERROR: iOS project not found!"
            echo "Run locally: flutter create --platforms=ios ."
            exit 1
          fi
          echo "âœ… iOS project exists"
      
      - name: ðŸ” Verify Flutter Generated Files
        shell: bash
        run: |
          flutter pub get
          
          if [ ! -f "ios/Flutter/Generated.xcconfig" ]; then
            echo "âŒ ERROR: Flutter iOS config not generated!"
            exit 1
          fi
          echo "âœ… Flutter iOS config exists"
      
      - name: ðŸ“¦ Install CocoaPods
        shell: bash
        run: sudo gem install cocoapods -v 1.14.3
      
      - name: ðŸ”§ Pod Install
        shell: bash
        run: |
          cd ios
          pod install --repo-update
      
      - name: ðŸ—ï¸ Build iOS Simulator
        shell: bash
        run: flutter build ios --simulator --no-codesign --debug
      
      - name: âœ… iOS Build Complete
        shell: bash
        run: echo "iOS build completed successfully"

  comment-pr:
    name: ðŸ’¬ Comment on PR
    needs: [validate, build-android, build-web]
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' && success()
    
    steps:
      - name: ðŸ’¬ Post PR Comment
        uses: actions/github-script@v7
        with:
          script: |
            const body = `âœ… **Feature Validation Complete**
            
            - âœ… Analyzer: Passed
            - âœ… Tests: Passed
            - âœ… Android Build: Success
            - âœ… Web Build: Success
            
            Ready for review! ðŸš€`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            })
