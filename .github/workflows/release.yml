name: ðŸŽ‰ Release Pipeline

permissions:
  contents: write
  pull-requests: write
  checks: write

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., v4.0.3)'
        required: true
        type: string

env:
  FLUTTER_VERSION: "3.16.9"
  JAVA_VERSION: "17"
  JAVA_OPTS: "-Xmx4G -XX:+UseG1GC"
  GRADLE_OPTS: "-Dorg.gradle.jvmargs=-Xmx4g -Dorg.gradle.daemon=true -Dkotlin.daemon.jvmargs=-Xmx1g"

jobs:
  validate:
    name: ðŸŽ¯ Release Validation
    runs-on: ubuntu-latest
    timeout-minutes: 35
    
    steps:
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: ðŸ”§ Setup Flutter
        uses: ./.github/actions/setup-flutter
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          init-project: 'true'
      
      - name: â˜• Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ env.JAVA_VERSION }}
          cache: 'gradle'
      
      - name: ðŸ“¦ Install Build Tools
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y lcov bc
      
      - name: ðŸ” Run Analyzer (Strict)
        run: flutter analyze --fatal-infos
      
      - name: ðŸ§ª Run Full Test Suite
        run: |
          if [ -f ".ci/scripts/run_tests.sh" ]; then
            bash .ci/scripts/run_tests.sh all true
          else
            flutter test --coverage
          fi
      
      - name: ðŸ“Š Coverage Threshold Check
        continue-on-error: true
        run: |
          if [ -f ".ci/scripts/generate_coverage.sh" ]; then
            bash .ci/scripts/generate_coverage.sh
          fi
      
      - name: âœ… All Quality Gates
        uses: ./.github/actions/run-quality-gates
      
      - name: ðŸ“ˆ Upload Coverage
        uses: codecov/codecov-action@v4
        continue-on-error: true
        with:
          files: ./coverage/lcov.info
          token: ${{ secrets.CODECOV_TOKEN }}
          flags: release
          name: release-coverage

  build-android:
    name: ðŸ¤– Build Android Release
    needs: validate
    runs-on: ubuntu-latest
    timeout-minutes: 40
    
    steps:
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@v4
      
      - name: ðŸ”§ Setup Flutter
        uses: ./.github/actions/setup-flutter
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          init-project: 'true'
      
      - name: â˜• Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ env.JAVA_VERSION }}
          cache: 'gradle'
      
      - name: ðŸ“ Create local.properties
        run: |
          cat > android/local.properties << EOF
          sdk.dir=$ANDROID_HOME
          flutter.sdk=$FLUTTER_ROOT
          flutter.versionCode=100
          flutter.versionName=4.0.3
          EOF
      
      - name: ðŸ—ï¸ Build Android Release
        run: |
          flutter build apk --release --flavor production \
            --dart-define=API_BASE_URL=${{ secrets.API_BASE_URL }} \
            --dart-define=APP_NAME=${{ secrets.APP_NAME }} \
            --dart-define=CLOUDINARY_API_KEY=${{ secrets.CLOUDINARY_API_KEY }} \
            --dart-define=CLOUDINARY_API_SECRET=${{ secrets.CLOUDINARY_API_SECRET }} \
            --dart-define=CLOUDINARY_CLOUD_NAME=${{ secrets.CLOUDINARY_CLOUD_NAME }} \
            --dart-define=CLOUDINARY_UPLOAD_PRESET=${{ secrets.CLOUDINARY_UPLOAD_PRESET }} \
            --dart-define=FIREBASE_API_KEY=${{ secrets.FIREBASE_API_KEY }} \
            --dart-define=FIREBASE_APP_ID=${{ secrets.FIREBASE_APP_ID }} \
            --dart-define=FIREBASE_AUTH_DOMAIN=${{ secrets.FIREBASE_AUTH_DOMAIN }} \
            --dart-define=FIREBASE_CLIENT_EMAIL=${{ secrets.FIREBASE_CLIENT_EMAIL }} \
            --dart-define=FIREBASE_MESSAGING_SENDER_ID=${{ secrets.FIREBASE_MESSAGING_SENDER_ID }} \
            --dart-define=FIREBASE_PRIVATE_KEY="${{ secrets.FIREBASE_PRIVATE_KEY }}" \
            --dart-define=FIREBASE_PROJECT_ID=${{ secrets.FIREBASE_PROJECT_ID }} \
            --dart-define=FIREBASE_STORAGE_BUCKET=${{ secrets.FIREBASE_STORAGE_BUCKET }} \
            --dart-define=HOSTING_BASE=${{ secrets.HOSTING_BASE }} \
            --dart-define=PORT=${{ secrets.PORT }} \
            --dart-define=YANDEX_FOLDER_ID=${{ secrets.YANDEX_FOLDER_ID }} \
            --dart-define=YANDEX_SERVICE_ACCOUNT_KEY="${{ secrets.YANDEX_SERVICE_ACCOUNT_KEY }}"
          
          flutter build appbundle --release --flavor production \
            --dart-define=API_BASE_URL=${{ secrets.API_BASE_URL }} \
            --dart-define=APP_NAME=${{ secrets.APP_NAME }} \
            --dart-define=CLOUDINARY_API_KEY=${{ secrets.CLOUDINARY_API_KEY }} \
            --dart-define=CLOUDINARY_API_SECRET=${{ secrets.CLOUDINARY_API_SECRET }} \
            --dart-define=CLOUDINARY_CLOUD_NAME=${{ secrets.CLOUDINARY_CLOUD_NAME }} \
            --dart-define=CLOUDINARY_UPLOAD_PRESET=${{ secrets.CLOUDINARY_UPLOAD_PRESET }} \
            --dart-define=FIREBASE_API_KEY=${{ secrets.FIREBASE_API_KEY }} \
            --dart-define=FIREBASE_APP_ID=${{ secrets.FIREBASE_APP_ID }} \
            --dart-define=FIREBASE_AUTH_DOMAIN=${{ secrets.FIREBASE_AUTH_DOMAIN }} \
            --dart-define=FIREBASE_CLIENT_EMAIL=${{ secrets.FIREBASE_CLIENT_EMAIL }} \
            --dart-define=FIREBASE_MESSAGING_SENDER_ID=${{ secrets.FIREBASE_MESSAGING_SENDER_ID }} \
            --dart-define=FIREBASE_PRIVATE_KEY="${{ secrets.FIREBASE_PRIVATE_KEY }}" \
            --dart-define=FIREBASE_PROJECT_ID=${{ secrets.FIREBASE_PROJECT_ID }} \
            --dart-define=FIREBASE_STORAGE_BUCKET=${{ secrets.FIREBASE_STORAGE_BUCKET }} \
            --dart-define=HOSTING_BASE=${{ secrets.HOSTING_BASE }} \
            --dart-define=PORT=${{ secrets.PORT }} \
            --dart-define=YANDEX_FOLDER_ID=${{ secrets.YANDEX_FOLDER_ID }} \
            --dart-define=YANDEX_SERVICE_ACCOUNT_KEY="${{ secrets.YANDEX_SERVICE_ACCOUNT_KEY }}"
      
      - name: ðŸ“¤ Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: android-apk-release-${{ github.ref_name }}
          path: build/app/outputs/flutter-apk/*.apk
          retention-days: 90
      
      - name: ðŸ“¤ Upload AAB
        uses: actions/upload-artifact@v4
        with:
          name: android-aab-release-${{ github.ref_name }}
          path: build/app/outputs/bundle/productionRelease/*.aab
          retention-days: 90

  build-web:
    name: ðŸŒ Build Web Release
    needs: validate
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@v4
      
      - name: ðŸ”§ Setup Flutter
        uses: ./.github/actions/setup-flutter
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          init-project: 'true'
      
      - name: ðŸ—ï¸ Build Web Release
        run: |
          flutter build web --release --web-renderer canvaskit \
            --dart-define=API_BASE_URL=${{ secrets.API_BASE_URL }} \
            --dart-define=APP_NAME=${{ secrets.APP_NAME }} \
            --dart-define=CLOUDINARY_API_KEY=${{ secrets.CLOUDINARY_API_KEY }} \
            --dart-define=CLOUDINARY_API_SECRET=${{ secrets.CLOUDINARY_API_SECRET }} \
            --dart-define=CLOUDINARY_CLOUD_NAME=${{ secrets.CLOUDINARY_CLOUD_NAME }} \
            --dart-define=CLOUDINARY_UPLOAD_PRESET=${{ secrets.CLOUDINARY_UPLOAD_PRESET }} \
            --dart-define=FIREBASE_API_KEY=${{ secrets.FIREBASE_API_KEY }} \
            --dart-define=FIREBASE_APP_ID=${{ secrets.FIREBASE_APP_ID }} \
            --dart-define=FIREBASE_AUTH_DOMAIN=${{ secrets.FIREBASE_AUTH_DOMAIN }} \
            --dart-define=FIREBASE_CLIENT_EMAIL=${{ secrets.FIREBASE_CLIENT_EMAIL }} \
            --dart-define=FIREBASE_MESSAGING_SENDER_ID=${{ secrets.FIREBASE_MESSAGING_SENDER_ID }} \
            --dart-define=FIREBASE_PRIVATE_KEY="${{ secrets.FIREBASE_PRIVATE_KEY }}" \
            --dart-define=FIREBASE_PROJECT_ID=${{ secrets.FIREBASE_PROJECT_ID }} \
            --dart-define=FIREBASE_STORAGE_BUCKET=${{ secrets.FIREBASE_STORAGE_BUCKET }} \
            --dart-define=HOSTING_BASE=${{ secrets.HOSTING_BASE }} \
            --dart-define=PORT=${{ secrets.PORT }} \
            --dart-define=YANDEX_FOLDER_ID=${{ secrets.YANDEX_FOLDER_ID }} \
            --dart-define=YANDEX_SERVICE_ACCOUNT_KEY="${{ secrets.YANDEX_SERVICE_ACCOUNT_KEY }}"
      
      - name: ðŸ“¤ Upload Web Build
        uses: actions/upload-artifact@v4
        with:
          name: web-build-release-${{ github.ref_name }}
          path: build/web/
          retention-days: 90

  build-ios:
    name: ðŸŽ Build iOS Release
    needs: validate
    runs-on: macos-latest
    timeout-minutes: 70
    
    steps:
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@v4
      
      - name: ðŸ”§ Setup Flutter
        uses: ./.github/actions/setup-flutter
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          init-project: 'true'
      
      - name: ðŸ“¦ Install CocoaPods
        run: sudo gem install cocoapods -v 1.14.3
      
      - name: ðŸ”§ Pod Install
        run: |
          cd ios
          pod install --repo-update
      
      - name: ðŸ—ï¸ Build iOS Release
        run: |
          flutter build ios --simulator --no-codesign --release \
            --dart-define=API_BASE_URL=${{ secrets.API_BASE_URL }} \
            --dart-define=APP_NAME=${{ secrets.APP_NAME }} \
            --dart-define=CLOUDINARY_API_KEY=${{ secrets.CLOUDINARY_API_KEY }} \
            --dart-define=CLOUDINARY_API_SECRET=${{ secrets.CLOUDINARY_API_SECRET }} \
            --dart-define=CLOUDINARY_CLOUD_NAME=${{ secrets.CLOUDINARY_CLOUD_NAME }} \
            --dart-define=CLOUDINARY_UPLOAD_PRESET=${{ secrets.CLOUDINARY_UPLOAD_PRESET }} \
            --dart-define=FIREBASE_API_KEY=${{ secrets.FIREBASE_API_KEY }} \
            --dart-define=FIREBASE_APP_ID=${{ secrets.FIREBASE_APP_ID }} \
            --dart-define=FIREBASE_AUTH_DOMAIN=${{ secrets.FIREBASE_AUTH_DOMAIN }} \
            --dart-define=FIREBASE_CLIENT_EMAIL=${{ secrets.FIREBASE_CLIENT_EMAIL }} \
            --dart-define=FIREBASE_MESSAGING_SENDER_ID=${{ secrets.FIREBASE_MESSAGING_SENDER_ID }} \
            --dart-define=FIREBASE_PRIVATE_KEY="${{ secrets.FIREBASE_PRIVATE_KEY }}" \
            --dart-define=FIREBASE_PROJECT_ID=${{ secrets.FIREBASE_PROJECT_ID }} \
            --dart-define=FIREBASE_STORAGE_BUCKET=${{ secrets.FIREBASE_STORAGE_BUCKET }} \
            --dart-define=HOSTING_BASE=${{ secrets.HOSTING_BASE }} \
            --dart-define=PORT=${{ secrets.PORT }} \
            --dart-define=YANDEX_FOLDER_ID=${{ secrets.YANDEX_FOLDER_ID }} \
            --dart-define=YANDEX_SERVICE_ACCOUNT_KEY="${{ secrets.YANDEX_SERVICE_ACCOUNT_KEY }}"
      
      - name: âœ… iOS Build Complete
        run: echo "iOS release build completed"

  create-release:
    name: ðŸŽ Create GitHub Release
    needs: [build-android, build-web, build-ios]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    
    steps:
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@v4
      
      - name: ðŸ“¦ Download Android APK
        uses: actions/download-artifact@v4
        with:
          name: android-apk-release-${{ github.ref_name }}
          path: ./release-artifacts/android
      
      - name: ðŸ“¦ Download Android AAB
        uses: actions/download-artifact@v4
        with:
          name: android-aab-release-${{ github.ref_name }}
          path: ./release-artifacts/android
      
      - name: ðŸŽ‰ Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          name: Release ${{ github.ref_name }}
          body: |
            ## ðŸš€ Bazarigo Mobile ${{ github.ref_name }}
            
            ### ðŸ“¦ Downloads
            - APK files for Android
            - AAB for Google Play Store
            
            ### âœ… Quality Metrics
            - All tests passed
            - Code coverage threshold met
            - All quality gates passed
            
            ### ðŸ“ Changes
            See commit history for detailed changes.
          draft: false
          prerelease: false
          files: |
            ./release-artifacts/android/*.apk
            ./release-artifacts/android/*.aab
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
