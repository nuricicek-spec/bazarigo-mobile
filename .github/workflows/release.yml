name: ğŸ·ï¸ Release Pipeline

permissions:
  pull-requests: write
  contents: read

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version'
        required: true
        default: ''

env:
  FLUTTER_VERSION: "3.16.9"

jobs:
  release:
    name: ğŸš€ Create Release
    runs-on: ubuntu-latest
    timeout-minutes: 45
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: ğŸ”§ Setup Flutter
        uses: ./.github/actions/setup-flutter
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
      
      - name: ğŸ“¦ Install lcov (coverage tool)
        shell: bash
        run: |
          if ! command -v lcov &> /dev/null; then
            echo "Installing lcov..."
            sudo apt-get update -qq
            sudo apt-get install -y lcov
          else
            echo "lcov already installed"
          fi
      
      - name: ğŸ” Run Analyzer
        run: flutter analyze --no-fatal-infos
      
      - name: ğŸ§ª Run Tests
        run: |
          if [ -f ".ci/scripts/run_tests.sh" ]; then
            bash .ci/scripts/run_tests.sh
          else
            flutter test --coverage
          fi
      
      - name: ğŸ“Š Generate Coverage Report
        if: success()
        run: |
          if [ -f ".ci/scripts/generate_coverage.sh" ]; then
            bash .ci/scripts/generate_coverage.sh
          else
            echo "Coverage script not found, skipping"
          fi
      
      - name: âœ… Run Quality Gates
        uses: ./.github/actions/run-quality-gates
      
      - name: ğŸ“ˆ Upload Coverage
        if: success()
        uses: codecov/codecov-action@v4
        continue-on-error: true
        with:
          files: ./coverage/lcov.info
          token: ${{ secrets.CODECOV_TOKEN }}
          flags: unittests
          name: release-coverage
          fail_ci_if_error: false
      
      # ğŸ†• YENÄ°: Build Ã¶ncesi cache temizleme
      - name: ğŸ§¹ Clean Build Cache (Android)
        if: success()
        shell: bash
        run: flutter clean
      
      - name: ğŸ—ï¸ Build All Platforms
        if: success()
        uses: ./.github/actions/build-artifacts
        with:
          platform: android
          flavor: production
      
      # ğŸ†• YENÄ°: Build Ã¶ncesi cache temizleme
      - name: ğŸ§¹ Clean Build Cache (Web)
        if: success()
        shell: bash
        run: flutter clean
      
      - name: ğŸ—ï¸ Build Web
        if: success()
        uses: ./.github/actions/build-artifacts
        with:
          platform: web
          flavor: production
      
      - name: ğŸ·ï¸ Create GitHub Release
        if: success()
        uses: softprops/action-gh-release@v1
        with:
          name: Release ${{ github.ref_name }}
          draft: false
          prerelease: false
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
