name: üè∑Ô∏è Release Pipeline

permissions:
  pull-requests: write
  contents: read

on:
  push:
    tags:
      - 'v*'
  pull_request:
    branches:
      - main
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version'
        required: true
        default: ''

env:
  FLUTTER_VERSION: "3.16.9"
  JAVA_OPTS: "-Xmx4G -XX:+UseG1GC"
  GRADLE_OPTS: "-Dorg.gradle.jvmargs=-Xmx4g -Dorg.gradle.daemon=false -Dkotlin.daemon.jvmargs=-Xmx1g"

jobs:
  release:
    name: üöÄ Create Release (Android/Web)
    runs-on: ubuntu-latest
    timeout-minutes: 90
    
    steps:
      - name: üì• Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: üîß Setup Flutter
        uses: ./.github/actions/setup-flutter
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
      
      - name: üì¶ Install lcov
        shell: bash
        run: |
          if ! command -v lcov &> /dev/null; then
            sudo apt-get update -qq
            sudo apt-get install -y lcov
          fi
      
      - name: üîç Run Analyzer
        run: flutter analyze --no-fatal-infos
      
      - name: üß™ Run Tests
        run: |
          if [ -f ".ci/scripts/run_tests.sh" ]; then
            bash .ci/scripts/run_tests.sh
          else
            flutter test --coverage
          fi
      
      - name: üìä Generate Coverage Report
        if: success()
        run: |
          if [ -f ".ci/scripts/generate_coverage.sh" ]; then
            bash .ci/scripts/generate_coverage.sh
          else
            echo "Coverage script not found, skipping"
          fi
      
      - name: ‚úÖ Run Quality Gates
        uses: ./.github/actions/run-quality-gates
      
      - name: üìà Upload Coverage
        if: success()
        uses: codecov/codecov-action@v4
        continue-on-error: true
        with:
          files: ./coverage/lcov.info
          token: ${{ secrets.CODECOV_TOKEN }}
          flags: unittests
          name: release-coverage
          fail_ci_if_error: false
      
      - name: üßπ Clean Build Cache (Android)
        if: success()
        shell: bash
        run: flutter clean
      
      - name: üèóÔ∏è Build Android
        if: success()
        uses: ./.github/actions/build-artifacts
        with:
          platform: android
          flavor: production
      
      - name: üßπ Clean Build Cache (Web)
        if: success()
        shell: bash
        run: flutter clean
      
      - name: üèóÔ∏è Build Web
        if: success()
        uses: ./.github/actions/build-artifacts
        with:
          platform: web
          flavor: production
      
      - name: üè∑Ô∏è Create GitHub Release
        if: success()
        uses: softprops/action-gh-release@v1
        with:
          name: Release ${{ github.ref_name }}
          draft: false
          prerelease: false
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-ios:
    name: üçè Build iOS (Release)
    runs-on: macos-latest
    needs: release
    if: ${{ needs.release.result == 'success' }}
    timeout-minutes: 90
    
    steps:
      - name: üì• Checkout Code
        uses: actions/checkout@v4
      
      - name: üîß Setup Flutter
        uses: ./.github/actions/setup-flutter
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
      
      - name: üîÑ Recreate iOS project
        run: |
          echo "Recreating iOS project..."
          rm -rf ios
          flutter create --platforms=ios --org com.bazarigo.app .
          chmod -R 755 ios
      
      - name: üìÅ Create Firebase config from secrets
        run: |
          mkdir -p ios/Runner
          echo '<?xml version="1.0" encoding="UTF-8"?>' > ios/Runner/GoogleService-Info.plist
          echo '<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">' >> ios/Runner/GoogleService-Info.plist
          echo '<plist version="1.0">' >> ios/Runner/GoogleService-Info.plist
          echo '<dict>' >> ios/Runner/GoogleService-Info.plist
          echo '    <key>API_KEY</key>' >> ios/Runner/GoogleService-Info.plist
          echo "    <string>${{ secrets.FIREBASE_API_KEY }}</string>" >> ios/Runner/GoogleService-Info.plist
          echo '    <key>GCM_SENDER_ID</key>' >> ios/Runner/GoogleService-Info.plist
          echo "    <string>${{ secrets.FIREBASE_MESSAGING_SENDER_ID }}</string>" >> ios/Runner/GoogleService-Info.plist
          echo '    <key>PLIST_VERSION</key>' >> ios/Runner/GoogleService-Info.plist
          echo '    <string>1</string>' >> ios/Runner/GoogleService-Info.plist
          echo '    <key>BUNDLE_ID</key>' >> ios/Runner/GoogleService-Info.plist
          echo '    <string>com.bazarigo.app</string>' >> ios/Runner/GoogleService-Info.plist
          echo '    <key>PROJECT_ID</key>' >> ios/Runner/GoogleService-Info.plist
          echo "    <string>${{ secrets.FIREBASE_PROJECT_ID }}</string>" >> ios/Runner/GoogleService-Info.plist
          echo '    <key>STORAGE_BUCKET</key>' >> ios/Runner/GoogleService-Info.plist
          echo "    <string>${{ secrets.FIREBASE_STORAGE_BUCKET }}</string>" >> ios/Runner/GoogleService-Info.plist
          echo '    <key>IS_ADS_ENABLED</key>' >> ios/Runner/GoogleService-Info.plist
          echo '    <false/>' >> ios/Runner/GoogleService-Info.plist
          echo '    <key>IS_ANALYTICS_ENABLED</key>' >> ios/Runner/GoogleService-Info.plist
          echo '    <false/>' >> ios/Runner/GoogleService-Info.plist
          echo '    <key>IS_APPINVITE_ENABLED</key>' >> ios/Runner/GoogleService-Info.plist
          echo '    <true/>' >> ios/Runner/GoogleService-Info.plist
          echo '    <key>IS_GCM_ENABLED</key>' >> ios/Runner/GoogleService-Info.plist
          echo '    <true/>' >> ios/Runner/GoogleService-Info.plist
          echo '    <key>IS_SIGNIN_ENABLED</key>' >> ios/Runner/GoogleService-Info.plist
          echo '    <true/>' >> ios/Runner/GoogleService-Info.plist
          echo '    <key>GOOGLE_APP_ID</key>' >> ios/Runner/GoogleService-Info.plist
          echo "    <string>${{ secrets.FIREBASE_APP_ID }}</string>" >> ios/Runner/GoogleService-Info.plist
          echo '</dict>' >> ios/Runner/GoogleService-Info.plist
          echo '</plist>' >> ios/Runner/GoogleService-Info.plist
      
      - name: üìù Update AppDelegate.swift
        run: |
          mkdir -p ios/Runner
          echo 'import UIKit' > ios/Runner/AppDelegate.swift
          echo 'import Flutter' >> ios/Runner/AppDelegate.swift
          echo 'import FirebaseCore' >> ios/Runner/AppDelegate.swift
          echo '' >> ios/Runner/AppDelegate.swift
          echo '@UIApplicationMain' >> ios/Runner/AppDelegate.swift
          echo 'class AppDelegate: FlutterAppDelegate {' >> ios/Runner/AppDelegate.swift
          echo '  override func application(' >> ios/Runner/AppDelegate.swift
          echo '    _ application: UIApplication,' >> ios/Runner/AppDelegate.swift
          echo '    didFinishLaunchingWithOptions launchOptions: [UIApplication.LaunchOptionsKey: Any]?' >> ios/Runner/AppDelegate.swift
          echo '  ) -> Bool {' >> ios/Runner/AppDelegate.swift
          echo '    FirebaseApp.configure()' >> ios/Runner/AppDelegate.swift
          echo '    GeneratedPluginRegistrant.register(with: self)' >> ios/Runner/AppDelegate.swift
          echo '    return super.application(application, didFinishLaunchingWithOptions: launchOptions)' >> ios/Runner/AppDelegate.swift
          echo '  }' >> ios/Runner/AppDelegate.swift
          echo '}' >> ios/Runner/AppDelegate.swift
      
      - name: üì¶ Install CocoaPods
        run: |
          sudo gem install cocoapods -v 1.14.3
      
      - name: üîß Install iOS Dependencies
        run: |
          cd ios
          arch -x86_64 pod install --repo-update
      
      - name: üèóÔ∏è Build iOS (Release Simulator)
        run: |
          flutter build ios --simulator --release --no-codesign --verbose
