name: üöÄ Main Branch CI

permissions:
  pull-requests: write
  contents: read

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

env:
  FLUTTER_VERSION: "3.16.9"

jobs:
  validate:
    name: üß™ Validate & Build (Android/Web)
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
      - name: üì• Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: üîß Setup Flutter
        uses: ./.github/actions/setup-flutter
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
      
      - name: üì¶ Install lcov (coverage tool)
        shell: bash
        run: |
          if ! command -v lcov &> /dev/null; then
            echo "Installing lcov..."
            sudo apt-get update -qq
            sudo apt-get install -y lcov
          else
            echo "lcov already installed"
          fi
      
      - name: üîç Run Analyzer
        run: flutter analyze --no-fatal-infos
      
      - name: üß™ Run Tests
        run: |
          if [ -f ".ci/scripts/run_tests.sh" ]; then
            bash .ci/scripts/run_tests.sh
          else
            flutter test --coverage
          fi
      
      - name: üìä Generate Coverage Report
        if: success()
        run: |
          if [ -f ".ci/scripts/generate_coverage.sh" ]; then
            bash .ci/scripts/generate_coverage.sh
          else
            echo "Coverage script not found, skipping"
          fi
      
      - name: ‚úÖ Run Quality Gates
        uses: ./.github/actions/run-quality-gates
      
      - name: üìà Upload Coverage
        if: success()
        uses: codecov/codecov-action@v4
        continue-on-error: true
        with:
          files: ./coverage/lcov.info
          token: ${{ secrets.CODECOV_TOKEN }}
          flags: unittests
          name: main-coverage
          fail_ci_if_error: false
      
      - name: üßπ Clean Build Cache (Android)
        if: success()
        shell: bash
        run: flutter clean
      
      - name: üèóÔ∏è Build Android
        if: success()
        uses: ./.github/actions/build-artifacts
        with:
          platform: android
          flavor: production
      
      - name: üßπ Clean Build Cache (Web)
        if: success()
        shell: bash
        run: flutter clean
      
      - name: üèóÔ∏è Build Web
        if: success()
        uses: ./.github/actions/build-artifacts
        with:
          platform: web
          flavor: production

  build-ios:
    name: üçè Build iOS
    runs-on: macos-latest
    needs: validate  # ‚úÖ BU SATIRI EKLE!
    if: success()   # ‚úÖ Sadece validate ba≈üarƒ±lƒ±ysa √ßalƒ±≈üsƒ±n
    
    steps:
      - name: üì• Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: üîß Setup Flutter
        uses: ./.github/actions/setup-flutter
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
      
      - name: üîÑ Recreate iOS project
        run: |
          echo "Recreating iOS project structure..."
          rm -rf ios
          flutter create --platforms=ios --org com.bazarigo.app .
          echo "‚úÖ iOS project recreated"
      
      - name: üìÅ Restore Firebase files
        run: |
          echo "Restoring Firebase configuration files..."
          
          if [ -f "ios/Runner/GoogleService-Info.plist" ]; then
            echo "‚úÖ GoogleService-Info.plist already exists"
          else
            cat > ios/Runner/GoogleService-Info.plist << 'EOF'
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
<dict>
    <key>API_KEY</key>
    <string>AIzaSyAEiiZK6m74-GPt_X9U7mRaLKnlo0sCyxw</string>
    <key>GCM_SENDER_ID</key>
    <string>27693224000</string>
    <key>PLIST_VERSION</key>
    <string>1</string>
    <key>BUNDLE_ID</key>
    <string>com.bazarigo.app</string>
    <key>PROJECT_ID</key>
    <string>bazarigo-1876d</string>
    <key>STORAGE_BUCKET</key>
    <string>bazarigo-1876d.firebasestorage.app</string>
    <key>IS_ADS_ENABLED</key>
    <false/>
    <key>IS_ANALYTICS_ENABLED</key>
    <false/>
    <key>IS_APPINVITE_ENABLED</key>
    <true/>
    <key>IS_GCM_ENABLED</key>
    <true/>
    <key>IS_SIGNIN_ENABLED</key>
    <true/>
    <key>GOOGLE_APP_ID</key>
    <string>1:27693224000:ios:ff8ca9a346a7dcf325cfa5</string>
</dict>
</plist>
EOF
            echo "‚úÖ GoogleService-Info.plist created"
          fi
      
      - name: üìù Update AppDelegate.swift
        run: |
          cat > ios/Runner/AppDelegate.swift << 'EOF'
import UIKit
import Flutter
import FirebaseCore

@UIApplicationMain
class AppDelegate: FlutterAppDelegate {
  override func application(
    _ application: UIApplication,
    didFinishLaunchingWithOptions launchOptions: [UIApplication.LaunchOptionsKey: Any]?
  ) -> Bool {
    FirebaseApp.configure()
    GeneratedPluginRegistrant.register(with: self)
    return super.application(application, didFinishLaunchingWithOptions: launchOptions)
  }
}
EOF
          echo "‚úÖ AppDelegate.swift updated"
      
      - name: üìù Update Info.plist
        run: |
          cat > ios/Runner/Info.plist << 'EOF'
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
<dict>
    <key>CFBundleDevelopmentRegion</key>
    <string>en</string>
    <key>CFBundleDisplayName</key>
    <string>Bazarigo</string>
    <key>CFBundleExecutable</key>
    <string>$(EXECUTABLE_NAME)</string>
    <key>CFBundleIdentifier</key>
    <string>$(PRODUCT_BUNDLE_IDENTIFIER)</string>
    <key>CFBundleInfoDictionaryVersion</key>
    <string>6.0</string>
    <key>CFBundleName</key>
    <string>Bazarigo</string>
    <key>CFBundlePackageType</key>
    <string>APPL</string>
    <key>CFBundleShortVersionString</key>
    <string>4.0.3</string>
    <key>CFBundleVersion</key>
    <string>100</string>
    <key>LSRequiresIPhoneOS</key>
    <true/>
    <key>UIViewControllerBasedStatusBarAppearance</key>
    <false/>
    <key>UILaunchStoryboardName</key>
    <string>LaunchScreen</string>
    <key>UIMainStoryboardFile</key>
    <string>Main</string>
    <key>UISupportedInterfaceOrientations</key>
    <array>
        <string>UIInterfaceOrientationPortrait</string>
        <string>UIInterfaceOrientationLandscapeLeft</string>
        <string>UIInterfaceOrientationLandscapeRight</string>
    </array>
    <key>UISupportedInterfaceOrientations~ipad</key>
    <array>
        <string>UIInterfaceOrientationPortrait</string>
        <string>UIInterfaceOrientationPortraitUpsideDown</string>
        <string>UIInterfaceOrientationLandscapeLeft</string>
        <string>UIInterfaceOrientationLandscapeRight</string>
    </array>
    <key>NSAppTransportSecurity</key>
    <dict>
        <key>NSAllowsArbitraryLoads</key>
        <true/>
    </dict>
    <key>io.flutter.embedded_views_preview</key>
    <true/>
</dict>
</plist>
EOF
          echo "‚úÖ Info.plist updated"
      
      - name: üì¶ Install CocoaPods
        run: |
          sudo gem install cocoapods -v 1.14.3
      
      - name: üîß Install iOS Dependencies
        run: |
          cd ios
          arch -x86_64 pod install --repo-update
      
      - name: üèóÔ∏è Build iOS (Simulator)
        run: |
          flutter build ios --simulator --no-codesign --verbose
