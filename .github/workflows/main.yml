name: ðŸš€ Main Branch CI/CD

permissions:
  pull-requests: write
  contents: write
  checks: write

on:
  push:
    branches:
      - main

env:
  FLUTTER_VERSION: "3.16.9"
  JAVA_VERSION: "11"
  JAVA_OPTS: "-Xmx4G -XX:+UseG1GC"
  GRADLE_OPTS: "-Dorg.gradle.jvmargs=-Xmx4g -Dorg.gradle.daemon=true -Dkotlin.daemon.jvmargs=-Xmx1g"

jobs:
  validate:
    name: ðŸŽ¯ Validate & Test
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: ðŸ”§ Setup Flutter
        uses: ./.github/actions/setup-flutter
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
      
      - name: â˜• Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ env.JAVA_VERSION }}
          cache: 'gradle'
      
      - name: ðŸ“¦ Install lcov
        run: |
          if ! command -v lcov &> /dev/null; then
            sudo apt-get update -qq
            sudo apt-get install -y lcov bc
          fi
      
      - name: ðŸ” Run Analyzer
        run: flutter analyze --no-fatal-infos
      
      - name: ðŸ§ª Run Full Test Suite
        run: |
          if [ -f ".ci/scripts/run_tests.sh" ]; then
            bash .ci/scripts/run_tests.sh all true
          else
            flutter test --coverage
          fi
      
      - name: ðŸ“Š Generate Coverage
        if: success()
        continue-on-error: true
        run: |
          if [ -f ".ci/scripts/generate_coverage.sh" ]; then
            bash .ci/scripts/generate_coverage.sh
          fi
      
      - name: âœ… Quality Gates
        uses: ./.github/actions/run-quality-gates
      
      - name: ðŸ“ˆ Upload Coverage
        if: success()
        uses: codecov/codecov-action@v4
        continue-on-error: true
        with:
          files: ./coverage/lcov.info
          token: ${{ secrets.CODECOV_TOKEN }}
          flags: main-branch
          name: main-coverage

  build-android:
    name: ðŸ¤– Build Android
    needs: validate
    runs-on: ubuntu-latest
    timeout-minutes: 35
    
    steps:
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@v4
      
      - name: ðŸ”§ Setup Flutter
        uses: ./.github/actions/setup-flutter
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
      
      - name: â˜• Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ env.JAVA_VERSION }}
          cache: 'gradle'
      
      - name: ðŸ“ Create local.properties
        run: |
          cat > android/local.properties << EOF
          sdk.dir=$ANDROID_HOME
          flutter.sdk=$FLUTTER_ROOT
          flutter.versionCode=100
          flutter.versionName=4.0.3
          EOF
      
      - name: ðŸ—ï¸ Build Android APK & AAB
        run: |
          flutter build apk --release --flavor production --split-per-abi
          flutter build appbundle --release --flavor production
      
      - name: ðŸ“¤ Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: android-apk-main-${{ github.sha }}
          path: build/app/outputs/flutter-apk/*.apk
          retention-days: 30
      
      - name: ðŸ“¤ Upload AAB
        uses: actions/upload-artifact@v4
        with:
          name: android-aab-main-${{ github.sha }}
          path: build/app/outputs/bundle/productionRelease/*.aab
          retention-days: 30

  build-web:
    name: ðŸŒ Build Web
    needs: validate
    runs-on: ubuntu-latest
    timeout-minutes: 25
    
    steps:
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@v4
      
      - name: ðŸ”§ Setup Flutter
        uses: ./.github/actions/setup-flutter
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
      
      - name: ðŸ—ï¸ Build Web
        run: flutter build web --release --web-renderer canvaskit
      
      - name: ðŸ“¤ Upload Web Build
        uses: actions/upload-artifact@v4
        with:
          name: web-build-main-${{ github.sha }}
          path: build/web/
          retention-days: 30

  build-ios:
    name: ðŸŽ Build iOS
    needs: validate
    runs-on: macos-latest
    timeout-minutes: 60
    
    steps:
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@v4
      
      - name: ðŸ”§ Setup Flutter
        uses: ./.github/actions/setup-flutter
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
      
      - name: ðŸ“¦ Install CocoaPods
        run: sudo gem install cocoapods -v 1.14.3
      
      - name: ðŸ”§ Pod Install
        run: |
          cd ios
          pod install --repo-update
      
      - name: ðŸ—ï¸ Build iOS Simulator
        run: flutter build ios --simulator --no-codesign --release
      
      - name: âœ… iOS Build Complete
        run: echo "iOS build completed successfully"

  notify:
    name: ðŸ“¢ Notify Build Status
    needs: [validate, build-android, build-web, build-ios]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
      - name: ðŸŽ‰ Success Notification
        if: ${{ needs.validate.result == 'success' && needs.build-android.result == 'success' }}
        run: |
          echo "âœ… Main branch CI/CD completed successfully"
          echo "ðŸ“¦ All artifacts built and uploaded"
