name: ğŸš€ Main Branch CI

permissions:
  pull-requests: write
  contents: read

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

env:
  FLUTTER_VERSION: "3.16.9"
  JAVA_OPTS: "-Xmx4G -XX:+UseG1GC"
  GRADLE_OPTS: "-Dorg.gradle.jvmargs=-Xmx4g -Dorg.gradle.daemon=false -Dkotlin.daemon.jvmargs=-Xmx1g"

jobs:
  validate:
    name: ğŸ§ª Validate & Build (Android/Web)
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: ğŸ”§ Setup Flutter
        uses: ./.github/actions/setup-flutter
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
      
      - name: â˜• Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
      
      - name: ğŸ“¦ Install lcov
        shell: bash
        run: |
          if ! command -v lcov &> /dev/null; then
            sudo apt-get update -qq
            sudo apt-get install -y lcov
          fi
      
      - name: ğŸ” Run Analyzer
        run: flutter analyze --no-fatal-infos
      
      - name: ğŸ§ª Run Tests
        run: |
          if [ -f ".ci/scripts/run_tests.sh" ]; then
            bash .ci/scripts/run_tests.sh
          else
            flutter test --coverage
          fi
      
      - name: ğŸ“Š Generate Coverage Report
        if: success()
        run: |
          if [ -f ".ci/scripts/generate_coverage.sh" ]; then
            bash .ci/scripts/generate_coverage.sh
          else
            echo "Coverage script not found, skipping"
          fi
      
      - name: âœ… Run Quality Gates
        uses: ./.github/actions/run-quality-gates
      
      - name: ğŸ“ˆ Upload Coverage
        if: success()
        uses: codecov/codecov-action@v4
        continue-on-error: true
        with:
          files: ./coverage/lcov.info
          token: ${{ secrets.CODECOV_TOKEN }}
          flags: unittests
          name: main-coverage
          fail_ci_if_error: false
      
      - name: ğŸ§¹ Clean Build Cache (Android)
        if: success()
        shell: bash
        run: flutter clean
      
      - name: ğŸ—ï¸ Build Android
        if: success()
        uses: ./.github/actions/build-artifacts
        with:
          platform: android
          flavor: production
      
      - name: ğŸ§¹ Clean Build Cache (Web)
        if: success()
        shell: bash
        run: flutter clean
      
      - name: ğŸ—ï¸ Build Web
        if: success()
        uses: ./.github/actions/build-artifacts
        with:
          platform: web
          flavor: production

  build-ios:
    name: ğŸ Build iOS
    runs-on: macos-latest
    needs: validate
    if: ${{ needs.validate.result == 'success' }}
    timeout-minutes: 90
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
      
      - name: ğŸ”§ Setup Flutter
        uses: ./.github/actions/setup-flutter
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
      
      - name: ğŸ” Check iOS project
        id: check_ios
        run: |
          if [ -d "ios/Runner" ]; then
            echo "iOS project exists."
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "iOS project does not exist, creating..."
            echo "exists=false" >> $GITHUB_OUTPUT
          fi
      
      - name: ğŸ—ï¸ Create iOS project if missing
        if: steps.check_ios.outputs.exists == 'false'
        run: |
          flutter create --platforms=ios --org com.bazarigo.app .
          chmod -R 755 ios
      
      - name: ğŸ“ Create Firebase config from template
        run: |
          mkdir -p ios/Runner
          # Install envsubst if not available
          if ! command -v envsubst &> /dev/null; then
            brew install gettext
            brew link --force gettext
          fi
          export FIREBASE_API_KEY="${{ secrets.FIREBASE_API_KEY }}"
          export FIREBASE_MESSAGING_SENDER_ID="${{ secrets.FIREBASE_MESSAGING_SENDER_ID }}"
          export FIREBASE_PROJECT_ID="${{ secrets.FIREBASE_PROJECT_ID }}"
          export FIREBASE_STORAGE_BUCKET="${{ secrets.FIREBASE_STORAGE_BUCKET }}"
          export FIREBASE_APP_ID="${{ secrets.FIREBASE_APP_ID }}"
          envsubst < .github/templates/GoogleService-Info.plist.template > ios/Runner/GoogleService-Info.plist
      
      - name: ğŸ“ Ensure AppDelegate.swift
        run: |
          mkdir -p ios/Runner
          if [ ! -f "ios/Runner/AppDelegate.swift" ]; then
            echo 'import UIKit' > ios/Runner/AppDelegate.swift
            echo 'import Flutter' >> ios/Runner/AppDelegate.swift
            echo 'import FirebaseCore' >> ios/Runner/AppDelegate.swift
            echo '' >> ios/Runner/AppDelegate.swift
            echo '@UIApplicationMain' >> ios/Runner/AppDelegate.swift
            echo 'class AppDelegate: FlutterAppDelegate {' >> ios/Runner/AppDelegate.swift
            echo '  override func application(' >> ios/Runner/AppDelegate.swift
            echo '    _ application: UIApplication,' >> ios/Runner/AppDelegate.swift
            echo '    didFinishLaunchingWithOptions launchOptions: [UIApplication.LaunchOptionsKey: Any]?' >> ios/Runner/AppDelegate.swift
            echo '  ) -> Bool {' >> ios/Runner/AppDelegate.swift
            echo '    FirebaseApp.configure()' >> ios/Runner/AppDelegate.swift
            echo '    GeneratedPluginRegistrant.register(with: self)' >> ios/Runner/AppDelegate.swift
            echo '    return super.application(application, didFinishLaunchingWithOptions: launchOptions)' >> ios/Runner/AppDelegate.swift
            echo '  }' >> ios/Runner/AppDelegate.swift
            echo '}' >> ios/Runner/AppDelegate.swift
          else
            # Check if Firebase is configured, if not, add it
            if ! grep -q "FirebaseApp.configure()" ios/Runner/AppDelegate.swift; then
              echo "AppDelegate exists but Firebase not configured. Please manually configure Firebase in AppDelegate."
            fi
          fi
      
      - name: ğŸ“¦ Install CocoaPods
        run: |
          sudo gem install cocoapods -v 1.14.3
      
      - name: ğŸ iOS Pods Fix  # ğŸ”„ POD FIX EKLENDÄ°
        run: |
          cd ios
          rm -rf Pods
          rm -f Podfile.lock
          pod install --repo-update
      
      - name: ğŸ—ï¸ Build iOS (Simulator)
        run: |
          flutter build ios --simulator --no-codesign --verbose

# ğŸš« RELEASE ADIMI SÄ°LÄ°NDÄ° - softprops/action-gh-release kaldÄ±rÄ±ldÄ±
