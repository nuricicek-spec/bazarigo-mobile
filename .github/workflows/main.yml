name: üöÄ Main Branch CI/CD

permissions:
  pull-requests: write
  contents: write
  checks: write

on:
  push:
    branches:
      - main

env:
  FLUTTER_VERSION: "3.16.9"
  JAVA_VERSION: "17"
  JAVA_OPTS: "-Xmx4G -XX:+UseG1GC"
  GRADLE_OPTS: "-Dorg.gradle.jvmargs=-Xmx4g -Dorg.gradle.daemon=true -Dkotlin.daemon.jvmargs=-Xmx1g"

jobs:
  validate:
    name: üéØ Validate & Test
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
      - name: üì• Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: üîß Setup Flutter
        uses: ./.github/actions/setup-flutter
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          init-project: 'true'
      
      - name: ‚òï Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ env.JAVA_VERSION }}
          cache: 'gradle'
      
      - name: üì¶ Install lcov
        run: |
          if ! command -v lcov &> /dev/null; then
            sudo apt-get update -qq
            sudo apt-get install -y lcov bc
          fi
      
      - name: üîç Run Analyzer
        run: flutter analyze --no-fatal-infos
      
      - name: üß™ Run Full Test Suite
        run: |
          if [ -f ".ci/scripts/run_tests.sh" ]; then
            bash .ci/scripts/run_tests.sh all true
          else
            flutter test --coverage
          fi
      
      - name: üìä Generate Coverage
        if: success()
        continue-on-error: true
        run: |
          if [ -f ".ci/scripts/generate_coverage.sh" ]; then
            bash .ci/scripts/generate_coverage.sh
          fi
      
      - name: ‚úÖ Quality Gates
        uses: ./.github/actions/run-quality-gates
      
      - name: üìà Upload Coverage
        if: success()
        uses: codecov/codecov-action@v4
        continue-on-error: true
        with:
          files: ./coverage/lcov.info
          token: ${{ secrets.CODECOV_TOKEN }}
          flags: main-branch
          name: main-coverage

  build-android:
    name: ü§ñ Build Android
    needs: validate
    runs-on: ubuntu-latest
    timeout-minutes: 35
    
    steps:
      - name: üì• Checkout Code
        uses: actions/checkout@v4
      
      - name: üîß Setup Flutter
        uses: ./.github/actions/setup-flutter
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          init-project: 'true'
      
      - name: ‚òï Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ env.JAVA_VERSION }}
          cache: 'gradle'
      
      - name: üìù Create local.properties
        run: |
          cat > android/local.properties << EOF
          sdk.dir=$ANDROID_HOME
          flutter.sdk=$FLUTTER_ROOT
          flutter.versionCode=100
          flutter.versionName=4.0.3
          EOF
      
      - name: üõ†Ô∏è Prepare JSON Secrets
        shell: bash
        run: |
          echo "FIREBASE_PRIVATE_KEY_ESC=$(echo -n '${{ secrets.FIREBASE_PRIVATE_KEY }}' | sed 's/"/\\"/g' | tr -d '\n')" >> $GITHUB_ENV
          echo "YANDEX_SERVICE_ACCOUNT_KEY_ESC=$(echo -n '${{ secrets.YANDEX_SERVICE_ACCOUNT_KEY }}' | sed 's/"/\\"/g' | tr -d '\n')" >> $GITHUB_ENV
      
      - name: üèóÔ∏è Build Android APK & AAB
        shell: bash
        run: |
          flutter build apk --release --flavor production --split-per-abi \
            --dart-define=API_BASE_URL=${{ secrets.API_BASE_URL }} \
            --dart-define=APP_NAME=${{ secrets.APP_NAME }} \
            --dart-define=CLOUDINARY_API_KEY=${{ secrets.CLOUDINARY_API_KEY }} \
            --dart-define=CLOUDINARY_API_SECRET=${{ secrets.CLOUDINARY_API_SECRET }} \
            --dart-define=CLOUDINARY_CLOUD_NAME=${{ secrets.CLOUDINARY_CLOUD_NAME }} \
            --dart-define=CLOUDINARY_UPLOAD_PRESET=${{ secrets.CLOUDINARY_UPLOAD_PRESET }} \
            --dart-define=FIREBASE_API_KEY=${{ secrets.FIREBASE_API_KEY }} \
            --dart-define=FIREBASE_APP_ID=${{ secrets.FIREBASE_APP_ID }} \
            --dart-define=FIREBASE_AUTH_DOMAIN=${{ secrets.FIREBASE_AUTH_DOMAIN }} \
            --dart-define=FIREBASE_CLIENT_EMAIL=${{ secrets.FIREBASE_CLIENT_EMAIL }} \
            --dart-define=FIREBASE_MESSAGING_SENDER_ID=${{ secrets.FIREBASE_MESSAGING_SENDER_ID }} \
            --dart-define=FIREBASE_PRIVATE_KEY="${{ env.FIREBASE_PRIVATE_KEY_ESC }}" \
            --dart-define=FIREBASE_PROJECT_ID=${{ secrets.FIREBASE_PROJECT_ID }} \
            --dart-define=FIREBASE_STORAGE_BUCKET=${{ secrets.FIREBASE_STORAGE_BUCKET }} \
            --dart-define=HOSTING_BASE=${{ secrets.HOSTING_BASE }} \
            --dart-define=PORT=${{ secrets.PORT }} \
            --dart-define=YANDEX_FOLDER_ID=${{ secrets.YANDEX_FOLDER_ID }} \
            --dart-define=YANDEX_SERVICE_ACCOUNT_KEY="${{ env.YANDEX_SERVICE_ACCOUNT_KEY_ESC }}"
          
          flutter build appbundle --release --flavor production \
            --dart-define=API_BASE_URL=${{ secrets.API_BASE_URL }} \
            --dart-define=APP_NAME=${{ secrets.APP_NAME }} \
            --dart-define=CLOUDINARY_API_KEY=${{ secrets.CLOUDINARY_API_KEY }} \
            --dart-define=CLOUDINARY_API_SECRET=${{ secrets.CLOUDINARY_API_SECRET }} \
            --dart-define=CLOUDINARY_CLOUD_NAME=${{ secrets.CLOUDINARY_CLOUD_NAME }} \
            --dart-define=CLOUDINARY_UPLOAD_PRESET=${{ secrets.CLOUDINARY_UPLOAD_PRESET }} \
            --dart-define=FIREBASE_API_KEY=${{ secrets.FIREBASE_API_KEY }} \
            --dart-define=FIREBASE_APP_ID=${{ secrets.FIREBASE_APP_ID }} \
            --dart-define=FIREBASE_AUTH_DOMAIN=${{ secrets.FIREBASE_AUTH_DOMAIN }} \
            --dart-define=FIREBASE_CLIENT_EMAIL=${{ secrets.FIREBASE_CLIENT_EMAIL }} \
            --dart-define=FIREBASE_MESSAGING_SENDER_ID=${{ secrets.FIREBASE_MESSAGING_SENDER_ID }} \
            --dart-define=FIREBASE_PRIVATE_KEY="${{ env.FIREBASE_PRIVATE_KEY_ESC }}" \
            --dart-define=FIREBASE_PROJECT_ID=${{ secrets.FIREBASE_PROJECT_ID }} \
            --dart-define=FIREBASE_STORAGE_BUCKET=${{ secrets.FIREBASE_STORAGE_BUCKET }} \
            --dart-define=HOSTING_BASE=${{ secrets.HOSTING_BASE }} \
            --dart-define=PORT=${{ secrets.PORT }} \
            --dart-define=YANDEX_FOLDER_ID=${{ secrets.YANDEX_FOLDER_ID }} \
            --dart-define=YANDEX_SERVICE_ACCOUNT_KEY="${{ env.YANDEX_SERVICE_ACCOUNT_KEY_ESC }}"
      
      - name: üì§ Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: android-apk-main-${{ github.sha }}
          path: build/app/outputs/flutter-apk/*.apk
          retention-days: 30
      
      - name: üì§ Upload AAB
        uses: actions/upload-artifact@v4
        with:
          name: android-aab-main-${{ github.sha }}
          path: build/app/outputs/bundle/productionRelease/*.aab
          retention-days: 30

  build-web:
    name: üåê Build Web
    needs: validate
    runs-on: ubuntu-latest
    timeout-minutes: 25
    
    steps:
      - name: üì• Checkout Code
        uses: actions/checkout@v4
      
      - name: üîß Setup Flutter
        uses: ./.github/actions/setup-flutter
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          init-project: 'true'
      
      - name: üõ†Ô∏è Prepare JSON Secrets
        shell: bash
        run: |
          echo "FIREBASE_PRIVATE_KEY_ESC=$(echo -n '${{ secrets.FIREBASE_PRIVATE_KEY }}' | sed 's/"/\\"/g' | tr -d '\n')" >> $GITHUB_ENV
          echo "YANDEX_SERVICE_ACCOUNT_KEY_ESC=$(echo -n '${{ secrets.YANDEX_SERVICE_ACCOUNT_KEY }}' | sed 's/"/\\"/g' | tr -d '\n')" >> $GITHUB_ENV
      
      - name: üèóÔ∏è Build Web
        shell: bash
        run: |
          flutter build web --release --web-renderer canvaskit \
            --dart-define=API_BASE_URL=${{ secrets.API_BASE_URL }} \
            --dart-define=APP_NAME=${{ secrets.APP_NAME }} \
            --dart-define=CLOUDINARY_API_KEY=${{ secrets.CLOUDINARY_API_KEY }} \
            --dart-define=CLOUDINARY_API_SECRET=${{ secrets.CLOUDINARY_API_SECRET }} \
            --dart-define=CLOUDINARY_CLOUD_NAME=${{ secrets.CLOUDINARY_CLOUD_NAME }} \
            --dart-define=CLOUDINARY_UPLOAD_PRESET=${{ secrets.CLOUDINARY_UPLOAD_PRESET }} \
            --dart-define=FIREBASE_API_KEY=${{ secrets.FIREBASE_API_KEY }} \
            --dart-define=FIREBASE_APP_ID=${{ secrets.FIREBASE_APP_ID }} \
            --dart-define=FIREBASE_AUTH_DOMAIN=${{ secrets.FIREBASE_AUTH_DOMAIN }} \
            --dart-define=FIREBASE_CLIENT_EMAIL=${{ secrets.FIREBASE_CLIENT_EMAIL }} \
            --dart-define=FIREBASE_MESSAGING_SENDER_ID=${{ secrets.FIREBASE_MESSAGING_SENDER_ID }} \
            --dart-define=FIREBASE_PRIVATE_KEY="${{ env.FIREBASE_PRIVATE_KEY_ESC }}" \
            --dart-define=FIREBASE_PROJECT_ID=${{ secrets.FIREBASE_PROJECT_ID }} \
            --dart-define=FIREBASE_STORAGE_BUCKET=${{ secrets.FIREBASE_STORAGE_BUCKET }} \
            --dart-define=HOSTING_BASE=${{ secrets.HOSTING_BASE }} \
            --dart-define=PORT=${{ secrets.PORT }} \
            --dart-define=YANDEX_FOLDER_ID=${{ secrets.YANDEX_FOLDER_ID }} \
            --dart-define=YANDEX_SERVICE_ACCOUNT_KEY="${{ env.YANDEX_SERVICE_ACCOUNT_KEY_ESC }}"
      
      - name: üì§ Upload Web Build
        uses: actions/upload-artifact@v4
        with:
          name: web-build-main-${{ github.sha }}
          path: build/web/
          retention-days: 30

  build-ios:
    name: üçé Build iOS
    needs: validate
    runs-on: macos-latest
    timeout-minutes: 60
    
    steps:
      - name: üì• Checkout Code
        uses: actions/checkout@v4
      
      - name: üîß Setup Flutter
        uses: ./.github/actions/setup-flutter
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          init-project: 'true'
      
      - name: üõ†Ô∏è Prepare JSON Secrets
        shell: bash
        run: |
          echo "FIREBASE_PRIVATE_KEY_ESC=$(echo -n '${{ secrets.FIREBASE_PRIVATE_KEY }}' | sed 's/"/\\"/g' | tr -d '\n')" >> $GITHUB_ENV
          echo "YANDEX_SERVICE_ACCOUNT_KEY_ESC=$(echo -n '${{ secrets.YANDEX_SERVICE_ACCOUNT_KEY }}' | sed 's/"/\\"/g' | tr -d '\n')" >> $GITHUB_ENV
      
      - name: üì¶ Install CocoaPods
        run: sudo gem install cocoapods -v 1.14.3
      
      - name: üîß Pod Install
        run: |
          cd ios
          pod install --repo-update
      
      - name: üèóÔ∏è Build iOS Simulator
        shell: bash
        run: |
          flutter build ios --simulator --no-codesign --release \
            --dart-define=API_BASE_URL=${{ secrets.API_BASE_URL }} \
            --dart-define=APP_NAME=${{ secrets.APP_NAME }} \
            --dart-define=CLOUDINARY_API_KEY=${{ secrets.CLOUDINARY_API_KEY }} \
            --dart-define=CLOUDINARY_API_SECRET=${{ secrets.CLOUDINARY_API_SECRET }} \
            --dart-define=CLOUDINARY_CLOUD_NAME=${{ secrets.CLOUDINARY_CLOUD_NAME }} \
            --dart-define=CLOUDINARY_UPLOAD_PRESET=${{ secrets.CLOUDINARY_UPLOAD_PRESET }} \
            --dart-define=FIREBASE_API_KEY=${{ secrets.FIREBASE_API_KEY }} \
            --dart-define=FIREBASE_APP_ID=${{ secrets.FIREBASE_APP_ID }} \
            --dart-define=FIREBASE_AUTH_DOMAIN=${{ secrets.FIREBASE_AUTH_DOMAIN }} \
            --dart-define=FIREBASE_CLIENT_EMAIL=${{ secrets.FIREBASE_CLIENT_EMAIL }} \
            --dart-define=FIREBASE_MESSAGING_SENDER_ID=${{ secrets.FIREBASE_MESSAGING_SENDER_ID }} \
            --dart-define=FIREBASE_PRIVATE_KEY="${{ env.FIREBASE_PRIVATE_KEY_ESC }}" \
            --dart-define=FIREBASE_PROJECT_ID=${{ secrets.FIREBASE_PROJECT_ID }} \
            --dart-define=FIREBASE_STORAGE_BUCKET=${{ secrets.FIREBASE_STORAGE_BUCKET }} \
            --dart-define=HOSTING_BASE=${{ secrets.HOSTING_BASE }} \
            --dart-define=PORT=${{ secrets.PORT }} \
            --dart-define=YANDEX_FOLDER_ID=${{ secrets.YANDEX_FOLDER_ID }} \
            --dart-define=YANDEX_SERVICE_ACCOUNT_KEY="${{ env.YANDEX_SERVICE_ACCOUNT_KEY_ESC }}"
      
      - name: ‚úÖ iOS Build Complete
        run: echo "iOS build completed successfully"

  notify:
    name: üì¢ Notify Build Status
    needs: [validate, build-android, build-web, build-ios]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
      - name: üéâ Success Notification
        if: ${{ needs.validate.result == 'success' && needs.build-android.result == 'success' }}
        run: |
          echo "‚úÖ Main branch CI/CD completed successfully"
          echo "üì¶ All artifacts built and uploaded"
